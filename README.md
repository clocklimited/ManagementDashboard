# Mangement Dashboard

## Setup

Run `npm install` first.

Go to the [Google Developers Console](https://console.developers.google.com/apis).

Create a new project.

Head to `Credentials`, then click `Create credentials` and then `Service account key`. Under `Service account`, select `New service account`. Now name the new service account, with a role of `Viewer` (under `Project`).

For the key type, select `JSON`. Click `Create` to generate and download the service account key.
**This file cannot be recovered if lost, keep it safe and secure.**

Rename it to `keyfile.json`, and move it into the `/lib/binary` directory (create it if needed).

Once completed, head back to the `Credentials` page, click `Create credentials` and then `OAuth Client ID`.

The application type is `Web application`. Set the name, and then set the `Authorised JavaScript origins` field to the address and port of the server, eg `http://localhost.clockhosting.com:9001`.

Set the `Authorised redirect URIs` field to the same as the `origins` field, but append `/auth/google/callback`.

Click `Create`, press `OK` (we will download the credentials as a file next), then click on the name of the OAuth client you just created.

Click `Download JSON` to download the OAuth Client details. **This file can be regenerated but must be kept secure.**

Rename the file to `oauth.json` and place it in the `/lib/binary` directory with `keyfile.json`.

Open `keyfile.json` and copy the `client_email` field.

Now, head to the spreadsheets that the service account needs access to.

Go to `File > Share` and enter the `client_email` you copied from the key file. **Be sure to set the permission to `Can View` only.**


That's it! Well done old chap.

*****
## Running
### Development

Watch index.js with `npm run watch`

Run server with `nodemon server.js`

Optionally, you can set the port with the `PORT` environment variable.

You can also set the secret key for session signing, but it is not required.

Open browser to `localhost:9001`

### Production

Build index.js with `npm run build`

Generate a secret key for session signing (recommended).

Run server with `SECRET=<SECRET_KEY> node server.js` (Or a `nodemon`-like program)

Optionally, you can set the port with the `PORT` environment variable.

Open browser to `localhost:9001`

## Other notes

#### Loss of service account key file/compromised file

If the service account key file has been lost/compromised, it is recommended to revoke the service account's access to the spreadsheets, and also delete it from the [Google Developers Console](https://console.developers.google.com/apis)

If this action does not need to be taken, the key file can be regenerated by following the steps above to create a service account, but using the previous service account in place of `New service account`. It is still recommended to remove the old service key from the developers console.
